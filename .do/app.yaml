# DigitalOcean App Platform Configuration
name: sunrise-school-management
region: blr1  # Bangalore, India region

# Environment variables (set these in DO dashboard)
envs:
- key: DATABASE_URL
  scope: RUN_AND_BUILD_TIME
  type: SECRET
- key: SECRET_KEY
  scope: RUN_AND_BUILD_TIME
  type: SECRET
- key: ENVIRONMENT
  scope: RUN_AND_BUILD_TIME
  value: production

# Services
services:
# FastAPI Backend
- name: backend
  source_dir: /sunrise-backend-fastapi
  github:
    repo: javedansari81/sunrise-school-management
    branch: main
    deploy_on_push: true
  
  # Build configuration
  build_command: |
    pip install -r requirements.txt
  
  # Run configuration
  run_command: uvicorn main:app --host 0.0.0.0 --port 8080
  
  # Environment
  environment_slug: python
  instance_count: 1
  instance_size_slug: basic-xxs  # $5/month
  
  # Health check
  health_check:
    http_path: /health
  
  # Routes
  routes:
  - path: /api
  - path: /docs
  - path: /redoc
  
  # CORS configuration
  cors:
    allow_origins:
    - exact: https://sunrise-school-management.ondigitalocean.app
    allow_methods:
    - GET
    - POST
    - PUT
    - DELETE
    - OPTIONS
    allow_headers:
    - Content-Type
    - Authorization

# React Frontend
- name: frontend
  source_dir: /sunrise-school-frontend
  github:
    repo: javedansari81/sunrise-school-management
    branch: main
    deploy_on_push: true
  
  # Build configuration
  build_command: |
    npm ci
    npm run build
  
  # Environment
  environment_slug: node-js
  
  # Static site configuration
  static_sites:
  - name: frontend
    source_dir: /build
    routes:
    - path: /
    catchall_document: index.html

# Database
databases:
- name: sunrise-postgres
  engine: PG
  version: "15"
  size: db-s-1vcpu-1gb  # $15.15/month
  num_nodes: 1
  
# Jobs (for database migrations)
jobs:
- name: migrate
  source_dir: /sunrise-backend-fastapi
  github:
    repo: javedansari81/sunrise-school-management
    branch: main
  
  run_command: |
    python setup_database.py
  
  environment_slug: python
  instance_count: 1
  instance_size_slug: basic-xxs
  
  kind: PRE_DEPLOY
